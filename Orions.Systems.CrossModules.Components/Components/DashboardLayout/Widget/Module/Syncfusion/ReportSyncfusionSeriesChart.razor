@namespace Orions.Systems.CrossModules.Components

@inherits DashboardComponent<ReportSyncfusionSeriesChartVm, ReportSyncfusionSeriesChartWidget>

@using Orions.Node.Common
@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.Charts
@using Syncfusion.EJ2.Blazor.SplitButtons

<div class="widget-content-report-linechart">

	@if (Vm.Report != null && Vm.IsLoadedReportResult)
	{
		@if (Widget.ShowTitle && Vm.ReportHasName)
		{
			<h3>@Vm.ReportName</h3>
		}

		<div class="widget-content-report-linechart-view">

			<EjsChart Title="@Widget.ChartTitle"
						 Background="@Widget.ChartBackground"
						 SelectionMode="SelectionMode.Series">

				<ChartEvents OnChartMouseClick="@ChartMouseClickHandler"></ChartEvents>
				<ChartEvents OnPointClick="@PointClickHandler"></ChartEvents>


				@if (ChartData.IsDateAxis)
				{
					<ChartPrimaryXAxis IsIndexed="@Widget.XAxisIsIndexed"
											 LabelPlacement="@Widget.LabelPlacement"
											 ValueType="Syncfusion.EJ2.Blazor.Charts.ValueType.DateTime"
											 IntervalType="@Widget.IntervalType"
											 LabelFormat="@Widget.LabelFormat"
											 Skeleton="@Widget.Skeleton"
											 EdgeLabelPlacement="@Widget.EdgeLabelPlacement">
					</ChartPrimaryXAxis>
				}
				else
				{
					<ChartPrimaryXAxis IsIndexed="@Widget.XAxisIsIndexed"
											 LabelPlacement="@Widget.LabelPlacement"
											 ValueType="Syncfusion.EJ2.Blazor.Charts.ValueType.Category"
											 IntervalType="@Widget.IntervalType"
											 LabelFormat="@Widget.LabelFormat"
											 Skeleton="@Widget.Skeleton"
											 EdgeLabelPlacement="@Widget.EdgeLabelPlacement">
					</ChartPrimaryXAxis>
				}

				<ChartTooltipSettings Enable="@Widget.IsEnableTooltip"></ChartTooltipSettings>

				<ChartLegendSettings Visible="@Widget.IsEnableLegend"
											Position="LegendPosition.Bottom">
				</ChartLegendSettings>

				<ChartZoomSettings EnableMouseWheelZooming="@Widget.EnableMouseWheelZooming"
										 EnablePinchZooming="@Widget.EnablePinchZooming"
										 EnableSelectionZooming="@Widget.EnableSelectionZooming"
										 EnablePan="@Widget.EnablePan"
										 EnableScrollbar="true">
				</ChartZoomSettings>

				<ChartCrosshairSettings Enable="@Widget.IsEnableCrosshair"></ChartCrosshairSettings>

				<ChartSeriesCollection>
					@foreach (var ser in ChartData.Series)
					{
						@if (ChartData.IsDateAxis)
						{
							<ChartSeries DataSource="@ser.Data"
											 Name="@ser.Name"
											 XName="@nameof(ReportSeriesChartDataItem.DatePosition)"
											 YName="@nameof(ReportSeriesChartDataItem.Count)"
											 Type="@Widget.ChartSeriesType">
								<ChartMarker>
									<ChartDataLabel Visible="@Widget.IsShowMarker"></ChartDataLabel>
								</ChartMarker>
							</ChartSeries>
						}
						else
						{
							<ChartSeries DataSource="@ser.Data"
											 Name="@ser.Name"
											 XName="@nameof(ReportSeriesChartDataItem.Time)"
											 YName="@nameof(ReportSeriesChartDataItem.Count)"
											 Type="@Widget.ChartSeriesType">
								<ChartMarker>
									<ChartDataLabel Visible="@Widget.IsShowMarker"></ChartDataLabel>
								</ChartMarker>
							</ChartSeries>
						}
					}

				</ChartSeriesCollection>
			</EjsChart>

		</div>

		@if (Widget.ShowFooter)
		{
			<div class="widget-content-report-linechart-footer">
				<div class="">Created at @Vm.Report.CreatedAtUTC</div>
			</div>
		}
	}

	@if (Vm.Report == null && Vm.IsLoadedReportResult)
	{
		<div class="widget-missing-report-data">
			Missing report data!
		</div>
	}

	@if (!Vm.IsLoadedReportResult)
	{
		<div style="position:relative;">
			<div class="loading-bar"></div>
		</div>
	}

	<div class="dashboard=onchart-click">@ChartClickHandlerMessage</div>

	<div class="col-xs-12 col-sm-12 col-lg-6 col-md-6">
		<EjsProgressButton Duration="99" OnClick="@OnApply" Content="Apply" IsPrimary="true">
		</EjsProgressButton>
	</div>

</div>

@code {

		public void OnApply()
		{
			// TEST CODE - TRYING TO CHANGE DATA ON RUNTIME TO MAKE SERIES REDUCE, BUT NO LUCK SO FAR
			var list = Vm.ReportChartData.Series.FirstOrDefault();
			Vm.ReportChartData.Series.Clear();

			if (list != null)
				Vm.ReportChartData.Series.Add(list);

			var list2 = Vm.ReportChartData.Categories.FirstOrDefault();
			Vm.ReportChartData.Categories.Clear();

			if (list2 != null)
				Vm.ReportChartData.Categories.Add(list2);

			this.StateHasChanged();
		}

	public string ChartClickHandlerMessage { get; set; }

	public ReportChartData ChartData => Vm.ReportChartData;

	protected override async Task OnInitializedAsync()
	{
		await Vm.RefreshReportResultData();

		await base.OnInitializedAsync();
	}

	protected override void OnStateHasChanged()
	{
		base.OnStateHasChanged();
	}

	public void ChartMouseClickHandler(IMouseEventArgs args)
	{
		// Here you can customize your code

		ChartClickHandlerMessage = $"ChartMouseClick at X:{args.X} Y:{args.Y}";
	}

	public void PointClickHandler(IPointEventArgs args)
	{
		// Here you can customize your code

		ChartClickHandlerMessage = $"PointClick at X:{args.X} Y:{args.Y}";
	}

}

<style>
	.widget-content-report-linechart {
		padding: 15px;
		overflow: hidden;
	}

		.widget-content-report-linechart h3 {
			text-align: center;
		}

	.widget-content-report-linechart-footer {
		font-size: 12px;
		font-style: italic;
	}

	svg > text {
		fill: white !important;
	}

	g > text {
		fill: white !important;
	}
</style>
