@namespace Orions.Systems.CrossModules.Components

@inherits DashboardComponent<ReportSyncfusionSeriesChartVm, ReportSyncfusionSeriesChartWidget>

@using Orions.Node.Common
@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.Charts
@using Syncfusion.EJ2.Blazor.SplitButtons

<div class="widget-content-report">

	@if (Vm.Report != null && Vm.IsLoadedReportResult)
	{
		@if (Widget.ShowTitle)
		{
			<h3>@Widget.Label</h3>
		}

		@if (Showing)
		{
			<div class="widget-content-report-view">

				<EjsChart @ref="Chartobj"
							 Title="@Widget.ChartTitle"
							 Background="@Widget.ChartBackground"
							 SelectionMode="SelectionMode.Series">

					<ChartEvents OnChartMouseClick="@ChartMouseClickHandler"></ChartEvents>
					<ChartEvents OnPointClick="@PointClickHandler"></ChartEvents>


					@if (ChartData.IsDateAxis)
					{
						<ChartPrimaryXAxis IsIndexed="@Widget.XAxisIsIndexed"
												 LabelPlacement="@Widget.LabelPlacement"
												 ValueType="Syncfusion.EJ2.Blazor.Charts.ValueType.DateTime"
												 IntervalType="@Widget.IntervalType"
												 LabelFormat="@Widget.LabelFormat"
												 Skeleton="@Widget.Skeleton"
												 EdgeLabelPlacement="@Widget.EdgeLabelPlacement">
						</ChartPrimaryXAxis>
					}
					else
					{
						<ChartPrimaryXAxis IsIndexed="@Widget.XAxisIsIndexed"
												 LabelPlacement="@Widget.LabelPlacement"
												 ValueType="Syncfusion.EJ2.Blazor.Charts.ValueType.Category"
												 IntervalType="@Widget.IntervalType"
												 LabelFormat="@Widget.LabelFormat"
												 Skeleton="@Widget.Skeleton"
												 EdgeLabelPlacement="@Widget.EdgeLabelPlacement">
						</ChartPrimaryXAxis>
					}

					<ChartTooltipSettings Enable="@Widget.IsEnableTooltip"></ChartTooltipSettings>

					<ChartLegendSettings Visible="@Widget.IsEnableLegend"
												Position="LegendPosition.Bottom">
					</ChartLegendSettings>

					<ChartZoomSettings EnableMouseWheelZooming="@Widget.EnableMouseWheelZooming"
											 EnablePinchZooming="@Widget.EnablePinchZooming"
											 EnableSelectionZooming="@Widget.EnableSelectionZooming"
											 EnablePan="@Widget.EnablePan"
											 EnableScrollbar="true">
					</ChartZoomSettings>

					<ChartCrosshairSettings Enable="@Widget.IsEnableCrosshair"></ChartCrosshairSettings>

					<ChartSeriesCollection>
						@foreach (var ser in ChartData.Series)
						{
							@if (ChartData.IsDateAxis)
							{
								<ChartSeries DataSource="@ser.Data"
												 Name="@ser.Name"
												 XName="@nameof(ReportSeriesChartDataItem.DatePosition)"
												 YName="@nameof(ReportSeriesChartDataItem.Count)"
												 Type="@Widget.ChartSeriesType">
									<ChartMarker>
										<ChartDataLabel Visible="@Widget.IsShowMarker"></ChartDataLabel>
									</ChartMarker>
								</ChartSeries>
							}
							else
							{
								<ChartSeries DataSource="@ser.Data"
												 Name="@ser.Name"
												 XName="@nameof(ReportSeriesChartDataItem.Time)"
												 YName="@nameof(ReportSeriesChartDataItem.Count)"
												 Type="@Widget.ChartSeriesType">
									<ChartMarker>
										<ChartDataLabel Visible="@Widget.IsShowMarker"></ChartDataLabel>
									</ChartMarker>
								</ChartSeries>
							}
						}

					</ChartSeriesCollection>
				</EjsChart>

			</div>
		}

		@if (Widget.ShowFooter)
		{
			<div class="widget-content-report-footer">
				@if (Vm.ReportHasName)
				{
					<div class="widget-content-report-footer-name">@Vm.ReportName</div>
				}
				<div class="widget-content-report-footer-create">Created at @Vm.Report.CreatedAtUTC</div>
			</div>
		}
	}

	@if (Vm.Report == null && Vm.IsLoadedReportResult)
	{
		<div class="widget-missing-report">
			Missing report data!
		</div>
	}

	@if (!Vm.IsLoadedReportResult)
	{
		<div style="position:relative;">
			<div class="loading-bar"></div>
		</div>
	}

	<div class="dashboard-onchart-click">@ChartClickHandlerMessage</div>


	@* TEST BUTTON FOR TESTING CHANGING THE SERIES
			<div class="col-xs-12 col-sm-12 col-lg-6 col-md-6">
			<EjsProgressButton Duration="99" OnClick="@OnApply" Content="Apply" IsPrimary="true">
			</EjsProgressButton>
		</div>
	*@

</div>

@code {

	public EjsChart Chartobj;

	public bool Showing { get; set; } = true;

	public void OnApply()
	{
	}

	public string ChartClickHandlerMessage { get; set; }

	public ReportChartData ChartData => Vm.ReportChartData;

	protected override async Task OnInitializedAsync()
	{
		await Vm.RefreshReportResultData();

		Vm.OnReportResultChanged += OnChangeDataSource;
		await base.OnInitializedAsync();
	}

	private void OnChangeDataSource()
	{
		this.Showing = false;
		this.StateHasChanged();

		// This thread dispatch magic, forces the system to process this request separately as part of the next iteration. A single invoke does not do that.
		Task.Factory.StartNew(() => 
		{
			this.InvokeAsync(() =>
			{
				this.Showing = true;
				this.StateHasChanged();
			});
		});
	}

	protected override void OnStateHasChanged()
	{
		base.OnStateHasChanged();
	}

	public void ChartMouseClickHandler(IMouseEventArgs args)
	{
		// Here you can customize your code

		ChartClickHandlerMessage = $"ChartMouseClick at X:{args.X} Y:{args.Y}";
	}

	public void PointClickHandler(IPointEventArgs args)
	{
		// Here you can customize your code

		ChartClickHandlerMessage = $"Point:{args.Point}";
	}

}

<style>
	

	svg > text {
		fill: white !important;
	}

	g > text {
		fill: white !important;
	}
</style>
