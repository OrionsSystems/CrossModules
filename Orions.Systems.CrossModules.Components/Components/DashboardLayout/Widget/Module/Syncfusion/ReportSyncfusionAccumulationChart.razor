@namespace Orions.Systems.CrossModules.Components

@inherits DashboardComponent<ReportSyncfusionAccumulationChartVm, ReportSyncfusionAccumulationChartWidget>

@using Orions.Node.Common
@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.Charts
@using Syncfusion.EJ2.Blazor.SplitButtons

<div class="widget-content-report">

	@if (Vm.Report != null && Vm.IsLoadedReportResult)
	{
		<TitleCard Settings="Widget.TitleSettings"></TitleCard>

		@if (Showing)
		{
			<div class="widget-content-report-view widget-syncfusion">

				<EjsAccumulationChart @ref="Chartobj"
											 Height="@Widget.Height"
											 Width="@Widget.Width"
											 Title="@Widget.ChartTitle">

					<AccumulationChartEvents OnPointClick="@Vm.HandlePointOnclick"></AccumulationChartEvents>

					<AccumulationChartSeriesCollection>

						@foreach (var ser in ChartData.Series)
						{
							<AccumulationChartSeries DataSource="@ser.Data"
															 XName="@nameof(ReportSeriesChartDataItem.CategoryName)"
															 YName="@nameof(ReportSeriesChartDataItem.Value)"
															 Name="@(string.IsNullOrWhiteSpace(Widget.SeriesSettings.Name) ? ser.Name : Widget.SeriesSettings.Name)"
															 Radius="@Widget.Radius"
															 GroupTo="@Widget.SeriesSettings.GroupTo"
															 Explode="@Widget.SeriesSettings.Explode"
															 ExplodeAll="@Widget.SeriesSettings.ExplodeAll"
															 Border="@Widget.SeriesSettings.Border"
															 InnerRadius="@Widget.InnerRadius">

								<AccumulationChartEmptyPointSettings Mode="@Widget.PointMode"></AccumulationChartEmptyPointSettings>

								<AccumulationDataLabelSettings Visible="@Widget.SeriesSettings.DataLabel.Visible"
																		 Name="@ser.Name"
																		 Font="@Widget.SeriesSettings.DataLabel.Font"
																		 Position="@Widget.SeriesSettings.DataLabel.Position">
								</AccumulationDataLabelSettings>

							</AccumulationChartSeries>
						}

					</AccumulationChartSeriesCollection>

					<AccumulationChartLegendSettings Position="@Widget.LegendSettings.Position"
																Alignment="@Widget.LegendSettings.Alignment"
																Visible="@Widget.LegendSettings.Visible">
					</AccumulationChartLegendSettings>

					<AccumulationChartTooltipSettings Enable="@Widget.TooltipSettings.Enable" 
																 Format="@Widget.TooltipSettings.Format"
																 Opacity="@Widget.TooltipSettings.Opacity"
																 Duration="@Widget.TooltipSettings.Duration"
																 Border="@Widget.TooltipSettings.Border"
																 TextStyle="@Widget.TooltipSettings.TextStyle"></AccumulationChartTooltipSettings>
				</EjsAccumulationChart>

			</div>
		}

		@if (Widget.ShowFooter)
		{
			<div class="widget-content-report-footer">
				@if (Vm.ReportHasName)
				{
					<div class="widget-content-report-footer-name">@Vm.ReportName</div>
				}
				<div class="widget-content-report-footer-create">Created at @Vm.Report.CreatedAtUTC</div>
			</div>
		}
	}

	@if (Vm.Report == null && Vm.IsLoadedReportResult)
	{
		<div class="widget-missing-report">
			Missing report data!
		</div>
	}

	@if (!Vm.IsLoadedReportResult)
	{
		<div style="position:relative;">
			<div class="loading-bar"></div>
		</div>
	}

</div>

@code {

	public EjsAccumulationChart Chartobj;

	public bool Showing { get; set; } = false;

	public void OnApply()
	{
	}

	public ReportChartData ChartData => Vm.ReportChartData;

	protected override async Task OnInitializedAsync()
	{
		Vm.OnReportResultChanged += OnChangeDataSource;
		await Vm.RefreshReportResultData();

		await base.OnInitializedAsync();
	}

	private void OnChangeDataSource()
	{
		this.Showing = true;
		this.StateHasChanged();
	}

	protected override void OnStateHasChanged()
	{
		base.OnStateHasChanged();
	}

}
