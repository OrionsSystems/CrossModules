@namespace Orions.Systems.CrossModules.Components

@inherits DashboardComponent<NumberCardVm, NumberCardWidget>

<div class="widget-content-report">

	@if (Vm.IsLoadedReportResult)
	{
		<SeparatorLine Settings="@Widget.TopSeparator"></SeparatorLine>
		<TitleCard Settings="Widget.TitleSettings"></TitleCard>

		<div class="widget-content-report-view">

			@if (Data.Any())
			{
				@foreach (var item in Data)
				{
					<div class="widget-single-analytics-title">@item.Title</div>
					<div class="widget-single-analytics-container">
						@if (Widget.IsShowCardIcons)
						{
							<div class="widget-single-analytics-icon">
								@if (string.IsNullOrWhiteSpace(item.SvgIcon))
								{
									<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
										  width="35px" height="35px" viewBox="0 0 35 35">
										<g>
											<rect width="15.909" height="35" />
											<rect x="19.091" y="12.727" width="15.909" height="9.546" />
											<rect x="19.091" width="15.909" height="9.545" />
											<rect x="19.091" y="25.455" width="15.909" height="9.545" />
										</g>
									</svg>
								}
								else
								{
									@((MarkupString)item.SvgIcon)
								}
							</div>
						}
						<div class="widget-single-analytics-value">@item.Value</div>
					</div>

					<SeparatorLine Settings="@Widget.SepratorsSettings"></SeparatorLine>

				}
			}
			else
			{
				<div class="widget-missing-report">
					Missing report data!
				</div>
			}

		</div>

		<SeparatorLine Settings="@Widget.BottomSeparator"></SeparatorLine>
	}

	@if (!Vm.IsLoadedReportResult)
	{
		<Loader Settings="@Widget.LoaderSettings"></Loader>
	}

</div>

@code {

	public List<CardItem> Data { get; set; } = new List<CardItem>();

	protected override async Task OnInitializedAsync()
	{
		Vm.OnReportResultChanged += OnChangeDataSource;

		await Vm.RefreshReportResultData();

		await base.OnInitializedAsync();
	}

	private void OnChangeDataSource()
	{
		if (Vm.ReportChartData != null)
		{
			foreach (var series in Vm.ReportChartData.Series)
			{
				var item = new CardItem()
				{
					Title = series.Name,
					Value = series.Data.LastOrDefault()?.Value
				};

				Data.Add(item);
			}
		}

		if (Widget.CustomItems.Any())
			Data.AddRange(Widget.CustomItems);

		StateHasChanged();
	}
}

